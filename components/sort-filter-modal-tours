"use client";

import { X, Flame, TrendingUp, Home, Bus, Utensils } from "lucide-react";
import { cn } from "@/lib/cn";
import { uiTransition } from "@/lib/ui";
import { useState } from "react";

export type TourSortKey = 
  | "relevance" 
  | "pay_desc" 
  | "pay_asc" 
  | "premium_first" 
  | "duration_desc" 
  | "duration_asc";

export interface TourFilters {
  onlyHot: boolean;
  onlyPremium: boolean;
  types: string[];
  sort: TourSortKey;
  accommodation: string[];
  withMeals: boolean;
  withTransfer: boolean;
}

interface Props {
  open: boolean;
  onClose: () => void;
  value: TourFilters;
  onChange: (filters: TourFilters) => void;
}

const TOUR_TYPES = [
  { id: "construction", label: "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ", icon: "üèóÔ∏è" },
  { id: "agriculture", label: "–°–µ–ª—å—Å–∫–æ–µ —Ö–æ–∑—è–π—Å—Ç–≤–æ", icon: "üåæ" },
  { id: "factory", label: "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ", icon: "üè≠" },
  { id: "service", label: "–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ", icon: "üõ†Ô∏è" },
  { id: "other", label: "–î—Ä—É–≥–æ–µ", icon: "üì¶" }
];

const ACCOMMODATION_TYPES = [
  { id: "hostel", label: "–•–æ—Å—Ç–µ–ª", icon: "üõå" },
  { id: "hotel", label: "–ì–æ—Å—Ç–∏–Ω–∏—Ü–∞", icon: "üè®" },
  { id: "apartment", label: "–ö–≤–∞—Ä—Ç–∏—Ä–∞", icon: "üè¢" },
  { id: "camp", label: "–õ–∞–≥–µ—Ä—å", icon: "‚õ∫" },
  { id: "dormitory", label: "–û–±—â–µ–∂–∏—Ç–∏–µ", icon: "üèòÔ∏è" }
];

const SORT_OPTIONS = [
  { id: "relevance" as TourSortKey, label: "–ü–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏" },
  { id: "pay_desc" as TourSortKey, label: "–ü–æ —É–±—ã–≤–∞–Ω–∏—é –∑–∞—Ä–ø–ª–∞—Ç—ã" },
  { id: "pay_asc" as TourSortKey, label: "–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –∑–∞—Ä–ø–ª–∞—Ç—ã" },
  { id: "premium_first" as TourSortKey, label: "–°–Ω–∞—á–∞–ª–∞ –≤—ã—Å–æ–∫–æ–æ–ø–ª–∞—á–∏–≤–∞–µ–º—ã–µ" },
  { id: "duration_desc" as TourSortKey, label: "–°–Ω–∞—á–∞–ª–∞ –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ" },
  { id: "duration_asc" as TourSortKey, label: "–°–Ω–∞—á–∞–ª–∞ –∫–æ—Ä–æ—Ç–∫–∏–µ" }
];

export default function SortFilterModalTours({
  open,
  onClose,
  value,
  onChange
}: Props) {
  const [localFilters, setLocalFilters] = useState<TourFilters>(value);

  const handleApply = () => {
    onChange(localFilters);
    onClose();
  };

  const handleReset = () => {
    const resetFilters: TourFilters = {
      onlyHot: false,
      onlyPremium: false,
      types: [],
      sort: "relevance",
      accommodation: [],
      withMeals: false,
      withTransfer: false
    };
    setLocalFilters(resetFilters);
    onChange(resetFilters);
  };

  const toggleType = (typeId: string) => {
    setLocalFilters(prev => ({
      ...prev,
      types: prev.types.includes(typeId)
        ? prev.types.filter(id => id !== typeId)
        : [...prev.types, typeId]
    }));
  };

  const toggleAccommodation = (accId: string) => {
    setLocalFilters(prev => ({
      ...prev,
      accommodation: prev.accommodation.includes(accId)
        ? prev.accommodation.filter(id => id !== accId)
        : [...prev.accommodation, accId]
    }));
  };

  if (!open) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      {/* Overlay */}
      <div 
        className="absolute inset-0 bg-black/40 backdrop-blur-sm"
        onClick={onClose}
      />
      
      {/* Modal */}
      <div className="relative z-10 w-full max-w-md rounded-2xl border border-zinc-200 bg-white shadow-2xl">
        {/* Header */}
        <div className="flex items-center justify-between border-b border-zinc-200 p-4">
          <div className="text-base font-semibold">–§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</div>
          <button
            onClick={onClose}
            className="tap rounded-xl p-2 hover:bg-zinc-100"
            aria-label="–ó–∞–∫—Ä—ã—Ç—å"
          >
            <X className="h-5 w-5" />
          </button>
        </div>

        {/* Content */}
        <div className="max-h-[70vh] overflow-y-auto p-4">
          {/* –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ */}
          <div className="mb-6">
            <div className="mb-3 text-sm font-semibold">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</div>
            <div className="space-y-2">
              {SORT_OPTIONS.map((option) => (
                <button
                  key={option.id}
                  onClick={() => setLocalFilters(prev => ({ ...prev, sort: option.id }))}
                  className={cn(
                    uiTransition,
                    "flex w-full items-center justify-between rounded-xl border px-4 py-3 text-sm",
                    localFilters.sort === option.id
                      ? "border-zinc-900 bg-zinc-900 text-white"
                      : "border-zinc-200 text-zinc-700 hover:bg-zinc-50"
                  )}
                >
                  <span>{option.label}</span>
                  {localFilters.sort === option.id && (
                    <div className="h-2 w-2 rounded-full bg-white" />
                  )}
                </button>
              ))}
            </div>
          </div>

          {/* –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã */}
          <div className="mb-6">
            <div className="mb-3 text-sm font-semibold">–ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</div>
            <div className="grid grid-cols-2 gap-2">
              <button
                onClick={() => setLocalFilters(prev => ({ ...prev, onlyHot: !prev.onlyHot }))}
                className={cn(
                  uiTransition,
                  "flex items-center justify-center gap-2 rounded-xl border px-3 py-2.5 text-sm",
                  localFilters.onlyHot
                    ? "border-red-200 bg-red-50 text-red-700"
                    : "border-zinc-200 text-zinc-700 hover:bg-zinc-50"
                )}
              >
                <Flame className="h-4 w-4" />
                –ì–æ—Ä—è—â–∏–µ
              </button>
              
              <button
                onClick={() => setLocalFilters(prev => ({ ...prev, onlyPremium: !prev.onlyPremium }))}
                className={cn(
                  uiTransition,
                  "flex items-center justify-center gap-2 rounded-xl border px-3 py-2.5 text-sm",
                  localFilters.onlyPremium
                    ? "border-emerald-200 bg-emerald-50 text-emerald-700"
                    : "border-zinc-200 text-zinc-700 hover:bg-zinc-50"
                )}
              >
                <TrendingUp className="h-4 w-4" />
                –í—ã—Å–æ–∫–∏–π –¥–æ—Ö–æ–¥
              </button>
              
              <button
                onClick={() => setLocalFilters(prev => ({ ...prev, withMeals: !prev.withMeals }))}
                className={cn(
                  uiTransition,
                  "flex items-center justify-center gap-2 rounded-xl border px-3 py-2.5 text-sm",
                  localFilters.withMeals
                    ? "border-green-200 bg-green-50 text-green-700"
                    : "border-zinc-200 text-zinc-700 hover:bg-zinc-50"
                )}
              >
                <Utensils className="h-4 w-4" />
                –° –ø–∏—Ç–∞–Ω–∏–µ–º
              </button>
              
              <button
                onClick={() => setLocalFilters(prev => ({ ...prev, withTransfer: !prev.withTransfer }))}
                className={cn(
                  uiTransition,
                  "flex items-center justify-center gap-2 rounded-xl border px-3 py-2.5 text-sm",
                  localFilters.withTransfer
                    ? "border-blue-200 bg-blue-50 text-blue-700"
                    : "border-zinc-200 text-zinc-700 hover:bg-zinc-50"
                )}
              >
                <Bus className="h-4 w-4" />
                –° —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–º
              </button>
            </div>
          </div>

          {/* –¢–∏–ø—ã —Ç—É—Ä–æ–≤ */}
          <div className="mb-6">
            <div className="mb-3 text-sm font-semibold">–¢–∏–ø —Ä–∞–±–æ—Ç—ã</div>
            <div className="flex flex-wrap gap-2">
              {TOUR_TYPES.map((type) => (
                <button
                  key={type.id}
                  onClick={() => toggleType(type.id)}
                  className={cn(
                    uiTransition,
                    "flex items-center gap-2 rounded-xl border px-3 py-2 text-sm",
                    localFilters.types.includes(type.id)
                      ? "border-zinc-900 bg-zinc-900 text-white"
                      : "border-zinc-200 text-zinc-700 hover:bg-zinc-50"
                  )}
                >
                  <span>{type.icon}</span>
                  {type.label}
                </button>
              ))}
            </div>
          </div>

          {/* –¢–∏–ø –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è */}
          <div className="mb-6">
            <div className="mb-3 text-sm font-semibold">–ü—Ä–æ–∂–∏–≤–∞–Ω–∏–µ</div>
            <div className="flex flex-wrap gap-2">
              {ACCOMMODATION_TYPES.map((acc) => (
                <button
                  key={acc.id}
                  onClick={() => toggleAccommodation(acc.id)}
                  className={cn(
                    uiTransition,
                    "flex items-center gap-2 rounded-xl border px-3 py-2 text-sm",
                    localFilters.accommodation.includes(acc.id)
                      ? "border-purple-200 bg-purple-50 text-purple-700"
                      : "border-zinc-200 text-zinc-700 hover:bg-zinc-50"
                  )}
                >
                  <span>{acc.icon}</span>
                  {acc.label}
                </button>
              ))}
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="border-t border-zinc-200 p-4">
          <div className="grid grid-cols-2 gap-3">
            <button
              onClick={handleReset}
              className="tap rounded-xl border border-zinc-200 bg-white px-4 py-3 text-sm font-medium text-zinc-700 hover:bg-zinc-50"
            >
              –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë
            </button>
            <button
              onClick={handleApply}
              className="tap rounded-xl bg-zinc-900 px-4 py-3 text-sm font-medium text-white hover:bg-zinc-800"
            >
              –ü—Ä–∏–º–µ–Ω–∏—Ç—å
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
